###Docker контейнеры для web-разработчика под OSX
Всю свою текущую разработку, я веду используя docker контейнеры, и если под linux такой подход не вызывает никаких проблем, то под макосью некоторые моменты могут отнять невероятное количество сил и времени.

Об одном из таких моментов я и хочу рассказать.

В моем случае, разработка с иcпользованием docker выглядит так - на контейнере поднят весь необходимый мне софт.   
Папки с рабочим проектом смаплены с хост системы в контейнер.   
В контейнере для автобилда настроен либо [grunt] с [grunt-contrib-watch], либо [watchify], либо порой просто висит скриптик использующий [inotify-tools].   
Дальше в случае веб разработки цикл простой - я правлю на Маке файл проекта, watch утилитки стартуют билд, livereload обновляет web страничку.

Все бы хорошо - но первая возникающая при таком подходе проблема, это то что входящая в Virtualbox Guest Additions файловая система vboxsf  невероятно медленная и вызывает целый ряд проблем:
* Все watch утилитки начинают грузить систему процентов на 200
* Даже небольшая сборка - например простая конкатенация файлов начинает занимать десятки секунд.

И это неприемлимо.

---

Быстрое гугление показало, что [nfs] работает в разы быстрее чем vboxfs.   
До кучи настроить [nfs] сервер под OSX быстро и легко.
```shell
#включить nfs сервер
sudo nfsd enable
#отредактировать файл с папками для шаринга
sudo vi /etc/exports
# добавить папки которые надо сделать доступными например  /Users/user/my_web_project -mapall=ice
#проверить что нет ошибок
sudo nfsd checkexports
#проверить что папки подцпились
showmount -e
```

Дальше надо передать в docker, ip адрес OSX хоста, чтобы можно было подцепить файловую систему
```shell
#получить ip хоста висящего на интерфейсе virtual box
HOST_IP=`ifconfig vboxnet0 | tail -1 | awk '{print $2}'`
#передать в контейнер
docker run --name smap -p 3080:3080 -e HOST_IP="$HOST_IP" -d -t sentimeta/node_scikit_image
```
В контейнере надо накатить [nfs] клиента и замаунтить нужные папки
```shell
#накатить клиента
sudo apt-get update
sudo apt-get install nfs-common
#замаунтить nfs osx папку
sudo mount -o nolock "$HOST_IP":/Users/user/my_web_project ~/my_web_project
```

---

И действительно две проблемы уходит
- загрузка процессора около ноля
- билд теперь идет очень быстро

Но появляется новая проблема - inotify события файловой системы [nfs] на которых сидят все watch утилитки, проходят, но с задержками по 10-20 секунд.   
И это неприемлимо.

---

Поэтому было принято решение начать ловить inotify события на host машине и передавать информацию в docker контейнер.   
Для решения проблемы я использовал следующие утилитки 
- на стороне докера [netcat] 
- на стороне OSX [fswatch] и [curl]

#####Сторона докера 
Вешаем http веб сервер на 3080 порт 
```shell
watch -n0 'printf "HTTP/1.1 200 OK\n\n$(date && touch /home/user/my_web_project/watchhelper.tmp)\n" | nc -l -p 3080 >/dev/null && date'
```
это самый __настоящий веб сервер на bash__ висящий на 3080 порту,    
на каждый запрос он выполняет команду date и touch файла watchhelper.tmp который надо положить вне исходников вашего проекта который надо добавить в watch. _ниже я поясню почему вне исходников проекта_
- touch команда "трогая" файл вызывает inotify событие приводяещее к сборке
- date команда удобна для тестирования, ее вывод и есть ответ этого сервера

Проверить что работает можно так:
- На OSX получаем адрес boot2docker виртуальной машины - `boot2docker ip 2>&1 | sed -n 2,2p | awk -F' ' '{print $9}'`
- Заходим в браузере по ip полученному предыдущей командой на порт 3080
И ура  - в браузере видим время, а в контейнере мгновенное срабатывание watch утилиток.


#####Сторона OSX
Устанавливаем fswatch   
`brew install fswatch`   
Запускаем
```shell
fswatch-run /Users/user/my_web_project/src "curl http://`boot2docker ip 2>&1 | sed -n 2,2p | awk -F' ' '{print $9}'`:3080"
```
Теперь при изменении любого файла в папке /Users/user/my_web_project/src будет вызван поднятый в контейнере веб сервер, который "потрогает" файл, что в свою очередь вызовет билд.

Файл watchhelper.tmp надо расположить вне исходников проекта по причине, что [nfs] все таки пропускает inotify события и лежащий в исходниках файл вызовет вечный цикл curl touch touch событий.

---

Различные вопросы настройки докер контейнеров под макось я нерегулярно добавляю в проект на гитхабе [istarkov/docker]

---

Если тема вызовет отклик - напишу еще несколько заслуживающих внимания вещей при использовании docker контейнеров при разработке на OSX.








































[grunt]:http://gruntjs.com/
[grunt-contrib-watch]:https://github.com/gruntjs/grunt-contrib-watch
[watchify]:https://github.com/substack/watchify
[inotify-tools]:https://github.com/rvoicilas/inotify-tools
[nfs]:http://en.wikipedia.org/wiki/Network_File_System
[netcat]:http://en.wikipedia.org/wiki/Netcat
[fswatch]:https://github.com/emcrisostomo/fswatch
[curl]:http://curl.haxx.se/
[istarkov/docker]:https://github.com/istarkov/docker
